<!DOCTYPE html>
<html lang="en">
    
    <head>
        <meta charset="utf-8">
        
        <title>Daft Punk</title>
        
        <style>
            body{font-size:1.5em;}
            
            
        </style>
        <script>
            "use strict";
            
            //script scope variables
            
            //play button
            let playButton;
            
            //sliders
            let bassBoost;
            let filmGrainEffect;
            let rotationSpeed;
            
            // radio buttons
            let colorScheme; // greyscale, neon, flat
            
            // checkboxes
            let audioReverb;
            let lightFlashes;
            let headBobbing;
            
            // 2 - elements on the page
            let audioElement,canvasElement;
            
            // 3 - our canvas drawing context
            let drawCtx;

            // 4 - our WebAudio context
            let audioCtx;

            // 5 - nodes that are part of our WebAudio audio routing graph
            let sourceNode, analyserNode, gainNode;

            // 6 - a typed array to hold the audio frequency data
            const NUM_SAMPLES = 256;
            // create a new array of 8-bit integers (0-255)
            let audioData = new Uint8Array(NUM_SAMPLES/2);
            
            // call init at the start
            window.onload = init;
        
            function setUpWebAudio()
            {
                const AudioContext = window.AudioContext || window.webkistAudioContext;
                audioCtx = new AudioContext();
                
                // reference to audio element
                audioElement = document.querySelector("audio");
                audioElement.src = "media/bensound-erf.mp3";
                
                // source that points to audio element
                sourceNode = audioCtx.createMediaElementSource(audioElement);
                
                // analyser node
                analyserNode = audioCtx.createAnalyser();
                
                analyserNode.fftSize =NUM_SAMPLES;
                
                // gain volume node
                gainNode = audioCtx.createGain();
                gainNode.gain.value = 1;
                
                // connect the nodes
                sourceNode.connect(analyserNode);
                analyserNode.connect(gainNode);
                gainNode.connect(audioCtx.destination);
            }     
            
            //initial function to be called when the page is loaded
            function init()
            {
                //set up the audio nodes
                setUpWebAudio();
                
                // set up the canvas
                canvasElement = document.querySelector('canvas');
                drawCtx = canvasElement.getContext('2d');
                
                // checked boxes
                document.querySelector("#reverb").onchange = e => audioReverb = e.target.checked;
                document.querySelector("#flashes").onchange = e => lightFlashes = e.target.checked;
                document.querySelector("#bobbing").onchange = e => headBobbing = e.target.checked;
                
                // sliders
                document.querySelector("#bass").onchange = e => bassBoost = e.target.value;
                document.querySelector("#grain").onchange = e => filmGrainEffect = e.target.value;
                document.querySelector("#rotSpeed").onchange = e => rotationSpeed = e.target.value;
                //volume slider
                let volumeSlider = document.querySelector("#volumeSlider");
                volumeSlider.oninput = e => {
                    gainNode.gain.value = e.target.value;
                    volumeLabel.innerHTML = Math.round((e.target.value/2 * 100));
                };
                volumeSlider.dispatchEvent(new InputEvent("input"));
                
                // radio buttons
                document.querySelector("#default").onchange = e => colorScheme = e.target.value;
                document.querySelector("#grayscale").onchange = e => colorScheme = e.target.value;
                document.querySelector("#neon").onchange = e => colorScheme = e.target.value;
                document.querySelector("#flat").onchange = e => colorScheme = e.target.value;
                
                //play button
                playButton = document.querySelector("#playButton");
                playButton.onclick = e => {
                    console.log(`audioCtx.state = ${audioCtx.state}`);

                    // check if context is in suspended state (autoplay policy)
                    if (audioCtx.state == "suspended") {
                        audioCtx.resume();
                    }

                    if (e.target.dataset.playing == "no") {
                        audioElement.play();
                        e.target.dataset.playing = "yes";
                    // if track is playing pause it
                    } else if (e.target.dataset.playing == "yes") {
                        audioElement.pause();
                        e.target.dataset.playing = "no";
                    }

                };
                // if track ends
                audioElement.onended =  _ => {
                    playButton.dataset.playing = "no";
                };
                
                //fullscreen button
                document.querySelector("#fsButton").onclick = _ =>{
                    requestFullscreen(canvasElement);
                };
                
                
                //start the update loop
                update();
            }
            
            //update called every frame
            function update()
            {
                // this schedules a call to the update() method in 1/60 seconds
                requestAnimationFrame(update);
                
                
            }
            
            //helper function for full-screening
            function requestFullscreen(element) {
                if (element.requestFullscreen) {
                  element.requestFullscreen();
                } else if (element.mozRequestFullscreen) {
                  element.mozRequestFullscreen();
                } else if (element.mozRequestFullScreen) { // camel-cased 'S' was changed to 's' in spec
                  element.mozRequestFullScreen();
                } else if (element.webkitRequestFullscreen) {
                  element.webkitRequestFullscreen();
                }
                // .. and do nothing if the method is not supported
            };
        </script>
    </head>
    
    <body>
        <canvas width="640" height="480">Get a real browser!</canvas>
        <audio></audio>
		<button id="playButton" data-playing="no">Play</button>
		<button id="fsButton">Full Screen</button>
        <div id="checkBoxSection">
            <p>Effects: </p>
            <input type="checkbox" id="reverb">Audio Reverb<br>
            <input type="checkbox" id="flashes">Light Flashes<br>
            <input type="checkbox" id="bobbing">Head Bobbing<br>
        </div>
            
        <div id="radioButtonSection">
            <p>Colorscheme: </p>
            <input type="radio" id="default" checked>Default<br>
            <input type="radio" id="grayscale">Grayscale<br>
            <input type="radio" id="neon">Neon<br>
            <input type="radio" id="flat">Flat<br>  
        </div>
        
        <div class="slidecontainer">
			<p>Volume:</p>
            <input type="range" id="volumeSlider" min="0" max="2" value="1" step="0.01">
			<span id="volumeLabel">???</span>
            <p>Bass Boost:</p>
            <input type="range" id="bass" min="1" max="100" value="50">
            <p>Film Grain Effect:</p>
            <input type="range" id="grain" min="1" max="100" value="50">
            <p>Rotation Speed:</p>
            <input type="range" id="rotSpeed" min="1" max="100" value="50">
        </div>
        <footer>Music: ERF from <a href="www.bensound.com">www.bensound.com</a></footer>
    </body>
    
</html>