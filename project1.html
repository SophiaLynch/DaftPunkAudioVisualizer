<!DOCTYPE html>
<html lang="en">
    
    <head>
        <meta charset="utf-8">
        
        <title>Daft Punk</title>
        
        <style>
            body{font-size:1.5em;}
            
            
        </style>
        <script>
            "use strict";
            
            //script scope variables
            
            //play button
            let playButton;
            
            //sliders
            let bassBoost = 0;
            let filmGrainEffect = 0;
            let bobbingSpeed = 5;
            
            // checkboxes
            let audioReverb;
            let lightFlashes;
            let headBobbing;
            
            //vars for assigning bobbing position
            let bobbingPos = 500;
            let goDown = false;
            
            // 2 - elements on the page
            let audioElement,canvasElement;
            
            // 3 - our canvas drawing context
            let drawCtx;
            
            //image vars
            let thomasHelmet = new Image();
            let guymanHelmet = new Image();

            // 4 - our WebAudio context
            let audioCtx;

            // 5 - nodes that are part of our WebAudio audio routing graph
            let sourceNode, analyserNode, lowShelfBiquadFilter, gainNode;

            // 6 - a typed array to hold the audio frequency data
            const NUM_SAMPLES = 256;
            // create a new array of 8-bit integers (0-255)
            let audioData = new Uint8Array(NUM_SAMPLES/2);
            
            // call init at the start
            window.onload = init;
        
            function setUpWebAudio()
            {
                const AudioContext = window.AudioContext || window.webkistAudioContext;
                audioCtx = new AudioContext();
                
                // reference to audio element
                audioElement = document.querySelector("audio");
                audioElement.src = "media/bensound-erf.mp3";
                
                // source that points to audio element
                sourceNode = audioCtx.createMediaElementSource(audioElement);
                
                // analyser node
                analyserNode = audioCtx.createAnalyser();
                
                analyserNode.fftSize =NUM_SAMPLES;
                
                //bass boost node, set to
                lowShelfBiquadFilter = audioCtx.createBiquadFilter();
                lowShelfBiquadFilter.type = "lowshelf";
                lowShelfBiquadFilter.frequency.setValueAtTime(1000, audioCtx.currentTime);
                lowShelfBiquadFilter.gain.setValueAtTime(bassBoost, audioCtx.currentTime);
                
                // gain volume node
                gainNode = audioCtx.createGain();
                gainNode.gain.value = 1;
                
                // connect the nodes
                sourceNode.connect(analyserNode);
                analyserNode.connect(lowShelfBiquadFilter);
                lowShelfBiquadFilter.connect(gainNode);
                gainNode.connect(audioCtx.destination);
            }     
            
            //initial function to be called when the page is loaded
            function init()
            {
                //set up the audio nodes
                setUpWebAudio();
                
                // set up the canvas
                canvasElement = document.querySelector('canvas');
                drawCtx = canvasElement.getContext('2d');
                
                // checked boxes
                document.querySelector("#reverb").onchange = e => audioReverb = e.target.checked;
                document.querySelector("#flashes").onchange = e => lightFlashes = e.target.checked;
                document.querySelector("#bobbing").onchange = e => headBobbing = e.target.checked;
                
                // sliders
                document.querySelector("#bass").onchange = e => bassBoost = e.target.value;
                document.querySelector("#grain").onchange = e => filmGrainEffect = e.target.value;
                document.querySelector("#bobSpeed").onchange = e => bobbingSpeed = e.target.value;
                //volume slider
                let volumeSlider = document.querySelector("#volumeSlider");
                volumeSlider.oninput = e => {
                    gainNode.gain.value = e.target.value;
                    volumeLabel.innerHTML = Math.round((e.target.value/2 * 100));
                };
                volumeSlider.dispatchEvent(new InputEvent("input"));

                //play button
                playButton = document.querySelector("#playButton");
                playButton.onclick = e => {
                    console.log(`audioCtx.state = ${audioCtx.state}`);

                    // check if context is in suspended state (autoplay policy)
                    if (audioCtx.state == "suspended") {
                        audioCtx.resume();
                    }

                    if (e.target.dataset.playing == "no") {
                        audioElement.play();
                        e.target.dataset.playing = "yes";
                    // if track is playing pause it
                    } else if (e.target.dataset.playing == "yes") {
                        audioElement.pause();
                        e.target.dataset.playing = "no";
                    }

                };
                // if track ends
                audioElement.onended =  _ => {
                    playButton.dataset.playing = "no";
                };
                
                //fullscreen button
                document.querySelector("#fsButton").onclick = _ =>{
                    requestFullscreen(canvasElement);
                };
                
                //set up images
                thomasHelmet.src = "media/dpThomas.png";
                guymanHelmet.src = "media/dpGuyman.png";
                
                //start the update loop
                update();
            }
            
            //update called every frame
            function update()
            {           
                //temp var for current radio selection
                let colorScheme = document.querySelector('input[name="colorScheme"]:checked').value;
                
                // this schedules a call to the update() method in 1/60 seconds
                requestAnimationFrame(update);
                
                //clear the previous frame
                drawCtx.clearRect(0,0,1000,1000);
                
                //draw a grey background
                drawCtx.save();
                drawCtx.fillStyle = "grey";
                drawCtx.fillRect(0,0,1000,1000);
                drawCtx.restore();
                
                //bass boost
                lowShelfBiquadFilter.frequency.setValueAtTime(1000, audioCtx.currentTime);
                lowShelfBiquadFilter.gain.setValueAtTime(bassBoost, audioCtx.currentTime);
                
                //head bobbing
                if(bobbingPos < 450){
                    bobbingPos = 450;
                    goDown = true;
                }
                if(bobbingPos > 550){
                    bobbingPos = 550;
                    goDown = false;
                }
                if(goDown){
                    bobbingPos += bobbingSpeed;
                } else{
                    bobbingPos -= bobbingSpeed;
                }
                                
                //images
                drawCtx.save();
				drawCtx.scale(.5,.5);
				drawCtx.drawImage(thomasHelmet,0,bobbingPos);
                drawCtx.drawImage(guymanHelmet,1000,bobbingPos);
				drawCtx.restore();
                
                // Bitmap Manipulation
                let imageData = drawCtx.getImageData(0, 0, 1000, 1000);
                let data = imageData.data;
                let length = data.length;
                // Iterate through each pixel
                for (let i = 0; i < length; i +=4) {
                    //grain
                    if (Math.random() < filmGrainEffect * 0.01){
                        data[i] = data[i+1] = data[i+2] = 255;
                        //console.log("Getting grainy!");
                    }
                    
                    //color scheme
                    switch(colorScheme){
                        case "grayscale":
                            data[i] = data[i + 1] = data[i + 2] = data[i] + data[i + 1] + data[i + 2] / 3;
                            break;
                        case "neon":
                            if(data[i] > data[i + 1] && data[i] > data[i + 2]){
                                data[i] += 75;
                            }
                            else if(data[i + 1] > data[i] && data[i + 1] > data[i + 2]){
                                data[i + 1] += 75;
                            }
                            else if(data[i + 2] > data[i + 1] && data[i + 2] > data[i]){
                                data[i + 2] += 75;
                            }
                            break;
                        case "flat":
                            data[i] = 0;
                            data[i + 1] = 0;     
                            break;
                        default:
                            break;
                    }
                }	// end for  
            }
            
            //helper function for full-screening
            function requestFullscreen(element) {
                if (element.requestFullscreen) {
                  element.requestFullscreen();
                } else if (element.mozRequestFullscreen) {
                  element.mozRequestFullscreen();
                } else if (element.mozRequestFullScreen) { // camel-cased 'S' was changed to 's' in spec
                  element.mozRequestFullScreen();
                } else if (element.webkitRequestFullscreen) {
                  element.webkitRequestFullscreen();
                }
                // .. and do nothing if the method is not supported
            };
        </script>
    </head>
    
    <body>
        <canvas width="1000" height="1000">Get a real browser!</canvas>
        <audio></audio>
		<button id="playButton" data-playing="no">Play</button>
		<button id="fsButton">Full Screen</button>
        <div id="checkBoxSection">
            <p>Effects: </p>
            <input type="checkbox" id="reverb">Audio Reverb<br>
            <input type="checkbox" id="flashes">Light Flashes<br>
            <input type="checkbox" id="bobbing">Head Bobbing<br>
        </div>
            
        <div id="radioButtonSection">
            <p>Colorscheme: </p>
            <input type="radio" name="colorScheme" value="default" id="default" checked>Default<br>
            <input type="radio" name="colorScheme" value="grayscale" id="grayscale">Grayscale<br>
            <input type="radio" name="colorScheme" value="neon" id="neon">Neon<br>
            <input type="radio" name="colorScheme" value="flat" id="flat">Flat<br>  
        </div>
        
        <div class="slidecontainer">
			<span><label>Volume:</label><input type="range" id="volumeSlider" min="0" max="2" value="1" step="0.01"></span>
			<span id="volumeLabel">???</span>
            <span><label for="bass">Bass Boost:</label><input type="range" id="bass" min="0" max="20" value="0"></span>
            <span><label for="grain">Film Grain Effect:</label><input type="range" id="grain" min="0" max="100" value="0"></span>
            <span><label for="bobSpeed">Bobbing Speed:</label><input type="range" id="bobSpeed" min="0" max="10" value="5"></span>
        </div>
        <footer>Music: ERF from <a href="www.bensound.com">www.bensound.com</a></footer>
    </body>
    
</html>